<html>
<head>
    <title>MDSL Documentation</title>

    <!-- Syntax highlighting library -->
    <script src="prism.js"></script>
    <script src="prism-mdsl.js"></script>
    <link href="prism.css" rel="stylesheet" />

    <!-- Page styles -->
    <style type="text/css">
        #page {
            max-width: 1000px;
            border: 1px solid lightgray;
            border-radius: 5px;
            padding: 2em;
            margin: 0 auto;
        }
        hr {
            border: none;
            height: 1px;
            background-color: lightgray;
        }
        #table-of-contents {
            display: inline-block;
            margin: 1em;
            padding: 1em;
            border: 1px solid lightgray;
            border-radius: 5px;
        }
        #table-of-contents h2 {
            text-align: center;
        }
        .toc-1 {
            margin-left: 1em;
        }
        .toc-2 {
            margin-left: 2em;
        }
        .toc-3 {
            margin-left: 3em;
        }
        code {
            white-space: nowrap !important; /* don't line break inline code sections */
        }
        pre > code {
            white-space: pre !important; /* undo above rule for non-inline code sections */
        }
    </style>

    <!-- Table of contents generation -->
    <script src="jquery-3.3.1.min.js"></script>
    <script type="text/javascript">

        /**
         * @return the next index for the given level, for numbering the table of contents
         */
        function next_index(level) {
            var index = indexes[''+level]
            if (index === undefined) {
                index = 0
            }
            index += 1;
            indexes[''+level] = index
            return index;
        }
        var indexes = {};

        /**
         * Add the given element to the table of contents, as the next item at the given level
         * Also auto-number this element in the document
         */
        function make_toc_entry(element, parent_section_number) {
            var level_index = next_index(parent_section_number);
            var section_number = parent_section_number + '.' + level_index
            if (parent_section_number === '') {
                section_number = '' + level_index
            }
            var numbered_title = section_number + '&nbsp;&nbsp;' + element.innerHTML
            var level_number = (section_number.match(/[.]/g) || []).length // count number of '.' in section_number
            var href = encodeURIComponent(section_number + '_' + element.innerHTML.replace(/ /g, '_'))
            $('#table-of-contents')
                .append($('<p>').addClass('toc-' + level_number)
                    .append($('<a>').attr('href', '#' + href)
                        .append(numbered_title)));
            $(element).html($('<a>').attr('name', href).html(numbered_title));
            return section_number
        }

        /**
         * Generate the table of contents
         */
        $(function() {
            $('h2', $('#content')).each(function() {
                var section_num_1 = make_toc_entry(this, '');
                $('h3', $(this).next().next()).each(function() {
                    var section_num_2 = make_toc_entry(this, section_num_1);
                    $('h4', $(this).next().next()).each(function() {
                        var section_num_3 = make_toc_entry(this, section_num_2);
                        $('h5', $(this).next().next()).each(function() {
                            var section_num_4 = make_toc_entry(this, section_num_3);
                        });
                    });
                });
            });
        });
    </script>
</head>
<body>
<div id="page" class="language-mdsl">
    <h1>MDSL Documentation</h1><hr>

    <div id="table-of-contents">
        <h2>Table of contents</h2><hr>
    </div>

    <div id="content">

        <h2>Building the simulator</h2><hr>
        <div>

            <ul>
                <li>Clone the repository</li>
                <li>In the <code>simulator</code> directory, run the gradle task <code>jar</code>
                    <ul>
                        <li>This creates the simulator output file <code>simulator/build/libs/simulator.jar</code></li>
                    </ul>
                </li>
                <li>Copy this file to the directory in which you want to run your simulations</li>
            </ul>
        </div>

        <h2>Modifying the simulator</h2><hr>
        <div>

            <p>To modify the simulator code, clone the repository and modify the code in <code>simulator/src</code>.</p>
            <p>A test suite is provided, which can be run using gradle.</p>
        </div>

        <h2>Running a simulation</h2><hr>
        <div>

            <p>To run a simulation, create a new directory and copy the following files into it:</p>
            <ol>
                <li><code>simulator.jar</code>, the output of building the code using gradle</li>
                <li><code>run_simulation.py</code>, from the <code>simulator</code> directory in the repository</li>
                <li>A file called <code>inputs.txt</code>, containing the following inputs:
                    <pre><code class="language-none">
                        --model-file model.mdsl
                        --print all
                        --seconds 5000
                        --seconds-before-print 30
                    </code></pre>
                </li>
                <li>A file called <code>model.mdsl</code>, containing the model, for example:
                    <pre><code>
                        # Structure of the cells
                        initial tree { simulation { 3 cell } }

                        # Initial values of species
                        species a contained simulation = 100 ng.ml^-1
                        species r on cell = 10 receptors.cell^-1

                        # Parameter values controlling rates of reactions
                        parameter k_on = 0.2 ml.ng^-1.cell.receptors^-1.hour^-1
                        parameter k_d = 0.005 ng.ml^-1
                        parameter k_off = k_on / k_d cell.receptors^-1.hour^-1
                        parameter k_signal = 0.8 cell.receptors^-1.hour^-1

                        # Reaction of the ligand binding the receptor
                        a around cell binds r on cell modifier k_on <=> a_r_complex on cell modifier k_off

                        # Reaction of the signal being transduced into the cell
                        a_r_complex on cell modifier k_signal => a_r_complex on cell and 2 b contained cell
                    </code></pre>
                </li>
            </ol>

            <p>Then run the following command in this directory:</p>
            <ul>
                <li><code style="white-space: pre-line;">python run_simulation.py</code></li>
            </ul>


            <p>This will run the simulation, printing the results to the terminal, and writing the results to files in the <code>logs</code> directory.</p>

            <h3>Analysing simulation results</h3><hr>
            <div>

                <p>
                    The file <code>logs/output_Species.csv</code> contains
                    the concentrations of each species that has been requested for printing (with the <code>--print</code> input),
                    at each timepoint that has been requested for printing (with the <code>--seconds-before-print</code> or <code>--hours-before-print</code> input).
                    Its contents will look like the following (the exact numbers may vary for your simulation, as the simulator runs stochastically):
                </p>
                <pre><code>
                    [2019/04/08 16:19:25], a,r,a_r_complex,b,Seconds
                    [2019/04/08 16:19:25], 100,30,0,0,0
                    [2019/04/08 16:19:25], 95,25,5,0,30
                    [2019/04/08 16:19:25], 92,22,8,0,60
                    [2019/04/08 16:19:25], 94,24,6,0,90
                    [2019/04/08 16:19:25], 92,22,8,0,120
                    [2019/04/08 16:19:25], 90,20,10,0,150
                    [2019/04/08 16:19:25], 89,19,11,0,180
                    [2019/04/08 16:19:25], 90,20,10,0,210
                    [2019/04/08 16:19:25], 89,19,11,0,240
                    [2019/04/08 16:19:25], 90,20,10,0,270
                    [2019/04/08 16:19:25], 92,22,8,0,300
                    ...
                </code></pre>

                <p>
                    Different output files can be produced by using different log levels (with the <code>--log-level</code> input).
                </p>
                <p>
                    A sample analysis script is provided, to plot the contents of the <code>output_Species.csv</code> file.
                    This script is called <code>analyse_results.py</code> and can be found in the <code>simulator</code> directory in the repository.
                </p>
                <p>
                    This script can be run in the <code>logs</code> directory after the simulation has finished.
                    Alternatively, the simulator will run it automatically if the <code>--run-analysis</code> input is provided.
                    For running the analysis script automatically, two files need to be added to the directory in which the simulation is running:
                <ol>
                    <li><code>analyse_results.py</code> copied from the <code>simulator</code> directory</li>
                    <li>A file called <code>python_command.txt</code>, containing the python command on your system</li>
                </ol>
                </p>
                <p>Running this analysis script will produce a plot at <code>logs/output_Species.png</code>, which will look like the following
                    (the exact numbers may vary for your simulation, as the simulator runs stochastically):</p>
                <p><img src="output_Species.png"></p>
            </div>

            <h3>Simulator inputs</h3><hr>
            <div>

                <p>These are the inputs that you can pass to the simulator, to control how it runs.</p>
                <p>This list can be obtained from the simulator by passing the <code>-h</code> or <code>--help</code> inputs.</p>

                <ul>
                    <li><code>--model-file</code>
                        <ul>
                            <li>MDSL file containing the model to simulate</li>
                            <li>The only required input</li>
                        </ul>
                    </li>

                    <li><code>--log-dir</code>
                        <ul>
                            <li>The directory into which to write the log files. Any pervious log files in this directory will be deleted.</li>
                            <li>Default: logs</li>
                        </ul>
                    </li>
                    <li><code>--log-level</code>
                        <ul>
                            <li>How much logging to print. Values are: ERROR, WARNING, WARNING_FIX, PROGRESS, PARAMETERS, TAGS, FULL_STATE_AT_END, PRINTED_SPECIES, PRINTED_SPECIES_PER_MEMBRANE, REACTION_NUMBERS, PRINTED_PROPENSITIES, DETAIL, DEBUG, FULL.</li>
                            <li>Default: PRINTED_SPECIES</li>
                        </ul>
                    </li>
                    <li><code>--print</code>, <code>-p</code>
                        <ul>
                            <li>Print this species to the output Default: [LD, INFg, IL10]</li>
                            <li>Can pass <code>all</code> to print everything</li>
                        </ul>
                    </li>

                    <li><code>--hours</code>
                        <ul>
                            <li>Number of (simulation) hours for which to run the simulation</li>
                        </ul>
                    </li>
                    <li><code>--hours-before-print</code>
                        <ul>
                            <li>Print out the results in chunks of this many hours</li>
                        </ul>
                    </li>
                    <li><code>--seconds</code>
                        <ul>
                            <li>Number of (simulation) seconds for which to run the simulation</li>
                        </ul>
                    </li>
                    <li><code>--seconds-before-print</code>
                        <ul>
                            <li>Print out the results in chunks of this many seconds</li>
                        </ul>
                    </li>

                    <li><code>--random-seed</code>
                        <ul>
                            <li>Seed for the random number generator</li>
                            <li>Set this to run exactly the same simulation again, including the same sequence of random numbers.</li>
                        </ul>
                    </li>
                    <li><code>--run-analysis</code>
                        <ul>
                            <li>Whether to run the analysis script after the simulation finishes</li>
                            <li>Default: false</li>
                            <li>This is the script <code>analyse_results.py</code></li>
                        </ul>
                    </li>
                </ul>
            </div>

            <h3>Log levels</h3><hr>
            <div>

                <p>The simulator can output different levels of logging information about the simulation.</p>
                <p>Logging more information generally makes the simulation run more slowly, but provides more detailed information about the state of the simulation.</p>
                <p>These are the different log levels and what they output. Each log level also includes all logs from previous levels.</p>

                <p>
                    Each log writes its output to a file of the format: <code>{log-dir}/output_{log-level}.txt</code>
                    Where <code>{log-dir}</code> is the <code>--log-dir</code> input parameter to the simulation, and <code>{log-level}</code> is the log level from the list below.
                </p>

                <ul>
                    <li><code>ERROR</code>
                        <ul>
                            <li>Messages detailing errors that prevent the simulation from running</li>
                        </ul>
                    </li>
                    <li><code>WARNING</code>
                        <ul>
                            <li>Messages detailing possible problems with the simulation, that do not prevent it running</li>
                        </ul>
                    </li>
                    <li><code>WARNING_FIX</code>
                        <ul>
                            <li>Information about how to fix the warnings from the WARNING log, if possible</li>
                        </ul>
                    </li>
                    <li><code>PROGRESS</code>
                        <ul>
                            <li>The precentage of the simulation that has been run</li>
                        </ul>
                    </li>
                    <li><code>PARAMETERS</code>
                        <ul>
                            <li>The parameters that this simulation was run using</li>
                        </ul>
                    </li>
                    <li><code>TAGS</code>
                        <ul>
                            <li>Information about the tags used in the model</li>
                        </ul>
                    </li>
                    <li><code>FULL_STATE_AT_END</code>
                        <ul>
                            <li>The full state of the simulation, just after the simulation has ended</li>
                        </ul>
                    </li>
                    <li><code>PRINTED_SPECIES</code>
                        <ul>
                            <li>The levels of each species that has been requested with the "--print" input, aggregated over all membranes</li>
                        </ul>
                    </li>
                    <li><code>PRINTED_SPECIES_PER_MEMBRANE</code>
                        <ul>
                            <li>The levels of each species that has been requested with the "--print" input, for each membrane</li>
                        </ul>
                    </li>
                    <li><code>REACTION_NUMBERS</code>
                        <ul>
                            <li>The reactions of the model, with unique ID numbers, for linking to the propensities output file below</li>
                        </ul>
                    </li>
                    <li><code>PRINTED_PROPENSITIES</code>
                        <ul>
                            <li>Reaction propensities at each timepoint of the simulation</li>
                        </ul>
                    </li>
                    <li><code>DETAIL</code>
                        <ul>
                            <li>A higher level of output about which steps the simulator is executing</li>
                        </ul>
                    </li>
                    <li><code>DEBUG</code>
                        <ul>
                            <li>Low-level debugging information, used to assist in fixing issues with the simulator</li>
                        </ul>
                    </li>
                    <li><code>FULL</code>
                        <ul>
                            <li>Full trace of very low-level steps, making the simulator run extremely slowly, used only for debugging</li>
                        </ul>
                    </li>
                </ul>
            </div>

        </div>

        <h2>MDSL Language</h2><hr>
        <div>

            <p>MDSL is a modelling language designed for describing models of chemical reactions that happen within and across membranes.</p>
            <p>It has been designed to be readable and understandable by biologists who do not have extensive modelling or computer programming experience.</p>

            <h3>Example</h3><hr>
            <div>

                <p>This is an example MDSL file. It is a very simple example model of signal transduction into a cell.</p>

                <pre><code>
                    # Structure of the cells
                    initial tree { simulation { 3 cell } }

                    # Initial values of species
                    species a contained simulation = 100 ng.ml^-1
                    species r on cell = 10 receptors.cell^-1

                    # Parameter values controlling rates of reactions
                    parameter k_on = 0.2 ml.ng^-1.cell.receptors^-1.hour^-1
                    parameter k_d = 0.005 ng.ml^-1
                    parameter k_off = k_on / k_d cell.receptors^-1.hour^-1
                    parameter k_signal = 0.8 cell.receptors^-1.hour^-1

                    # Reaction of the ligand binding the receptor
                    a around cell binds r on cell modifier k_on <=> a_r_complex on cell modifier k_off

                    # Reaction of the signal being transduced into the cell
                    a_r_complex on cell modifier k_signal => a_r_complex on cell and 2 b contained cell
                </code></pre>

                <p>The different parts of the file are described below:</p>

                <h4>Initial tree</h4><hr>
                <div>

                    <p>The <code>initial tree</code> defines the tree of membranes within which the simulation will run.</p>

                    <pre><code>
                        # Structure of the cells
                        initial tree { simulation { 3 cell } }
                    </code></pre>

                    <p>
                        The line above defines four membranes: an outer membrane called <code>simulation</code>,
                        containing three membranes each called <code>cell</code>.
                    </p>
                </div>

                <h4>Species definitions</h4><hr>
                <div>

                    <p>The <code>species</code> lines define initial values of the different species in the simulation.</p>

                    <pre><code>
                        # Initial values of species
                        species a contained simulation = 100 ng.ml^-1
                        species r on cell = 10 receptors.cell^-1
                    </code></pre>

                    <p>
                        Each species exists in a location, which is either
                        <code>contained</code>, <code>around</code>, <code>on</code>, or <code>under</code>
                        a membrane from the initial tree.
                    </p>
                    <p>
                        Since membranes can be contained within other membranes, the location <code>around</code> one membrane is
                        the same as the location <code>contained</code> its parent.
                        In our example, the location <code>contained simulation</code> is the same as the location <code>around cell</code>.
                    </p>
                    <p>
                        Each species definition must specify the units of the number.
                        Any units can be provided.
                        Units are not currently checked by the simulator; they are an aid to the writing of the model.
                    </p>
                </div>

                <h4>Parameter definitions</h4><hr>
                <div>

                    <p>The <code>parameter</code> lines define parameters that control the rates of reactions in the model.</p>

                    <pre><code>
                        # Parameter values controlling rates of reactions
                        parameter k_on = 0.2 ml.ng^-1.cell.receptors^-1.hour^-1
                        parameter k_d = 0.005 ng.ml^-1
                        parameter k_off = k_on / k_d cell.receptors^-1.hour^-1
                        parameter k_signal = 0.8 cell.receptors^-1.hour^-1
                    </code></pre>

                    <p>
                        Parameter values can be simple numbers, or equations referencing other parameters.
                        In this example the <code>k_off</code> parameter value is calculated from the <code>k_on</code> and <code>k_d</code> values.
                    </p>
                    <p>As with initial values of species, each parameter must specify its units.</p>
                </div>

                <h4>Ligand binding reaction</h4><hr>
                <div>

                    <p>
                        The first reaction defines the behaviour of the ligand <code>a</code> around the cell binding with the receptor <code>b</code> on the cell membrane,
                        to produce a complex, <code>a_r_complex</code>.
                    </p>

                    <pre><code>
                        # Reaction of the ligand binding the receptor
                        a around cell binds r on cell modifier k_on <=> a_r_complex on cell modifier k_off
                    </code></pre>

                    <p>This reaction is reversible, as indicated by the double arrow <code> <=> </code>.</p>
                    <p>
                        The reaction rate constant for the forward reaction is the value of the parameter <code>k_on</code>, as indicated by the <code>modifier</code> keyword on the left hand side of the reaction.
                        The rate constant for the reverse reaction is <code>k_off</code>, specified on the right hand side of the reaction.
                    </p>
                    <p>
                        When simulating the forward reaction, the rate of the reaction will be calculated by counting the number of <code>a around cell</code>,
                        multiplying this by the number of <code>r on cell</code> and multiplying it by <code>k_on</code>.
                        Thus this reaction will have a different rate for each cell in the simulation (of which we have 3 in this example).
                    </p>
                </div>

                <h4>Signal transduction reaction</h4><hr>
                <div>

                    <p>The second reaction models the activated receptor causing a signal molecule to be produced within the cell.</p>

                    <pre><code>
                        # Reaction of the signal being transduced into the cell
                        a_r_complex on cell modifier k_signal => a_r_complex on cell and 2 b contained cell
                    </code></pre>

                    <p>
                        This is a very high level model of signal transduction, which abstracts a lot of the biological steps into one process.
                        While the ligand is bound to the receptor, this reaction creates signal molecules, named <code>b</code>, within the cell.
                        The rate of signal production is determined by the number of bound receptors and by the <code>k_signal</code> parameter.
                    </p>
                </div>

            </div>

            <h3>MDSL language concepts</h3><hr>
            <div>
                <p>This section describes in detail each concept in the MDSL language.</p>

                <h4>Membranes</h4><hr>
                <div>

                    <p>Everything in MDSL happens in relation to a membrane.</p>
                    <p>Each membrane defines four locations in which species can exist and reactions can happen:</p>
                    <ol>
                        <li>the space <code>around</code> the membrane;</li>
                        <li>the space <code>contained</code> within the membrane;</li>
                        <li>the space of species bound <code>on</code> the membrane;</li>
                        <li>the space of species bound <code>under</code> the membrane.</li>
                    </ol>

                    <p>
                        The <code>initial tree</code> defines the structure of the membranes for the simulation.
                        The simplest valid <code>initial tree</code> is:
                    </p>
                    <pre><code>
                        initial tree { simulation }
                    </code></pre>
                    <p>
                        This defines a single membrane, called <code>simulation</code>.
                        All species and reaction in this model will be <code>contained</code> within this membrane.
                    </p>
                    <p>A more complex example of an <code>initial tree</code> is:</p>
                    <pre><code>
                        initial tree { A { 2 B { C } } { D } }
                    </code></pre>
                    <p>
                        This defines six membranes: the outer membrane, <code>A</code>, containing two <code>B</code>s and one <code>D</code>,
                        with each <code>B</code> containing one <code>C</code>.
                        The following diagram shows this structure:
                    </p>
                    <svg width="50%" version="1.1" viewBox="125.0 145.0 505.0 318.0" fill="none" stroke="none" stroke-linecap="square" stroke-miterlimit="10" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg"><clipPath id="p.0"><path d="m0 0l960.0 0l0 540.0l-960.0 0l0 -540.0z" clip-rule="nonzero"/></clipPath><g clip-path="url(#p.0)"><path fill="#ffffff" d="m0 0l960.0 0l0 540.0l-960.0 0z" fill-rule="evenodd"/><path fill="#000000" fill-opacity="0.0" d="m130.04987 201.7753l0 0c0 -28.296097 22.938522 -51.23462 51.23462 -51.23462l393.2788 0c13.588257 0 26.619995 5.3979187 36.228333 15.006271c9.608337 9.608353 15.006287 22.64009 15.006287 36.228348l0 204.93234c0 28.296082 -22.938538 51.23462 -51.23462 51.23462l-393.2788 0c-28.296097 0 -51.23462 -22.938538 -51.23462 -51.23462z" fill-rule="evenodd"/><path stroke="#595959" stroke-width="1.0" stroke-linejoin="round" stroke-linecap="butt" d="m130.04987 201.7753l0 0c0 -28.296097 22.938522 -51.23462 51.23462 -51.23462l393.2788 0c13.588257 0 26.619995 5.3979187 36.228333 15.006271c9.608337 9.608353 15.006287 22.64009 15.006287 36.228348l0 204.93234c0 28.296082 -22.938538 51.23462 -51.23462 51.23462l-393.2788 0c-28.296097 0 -51.23462 -22.938538 -51.23462 -51.23462z" fill-rule="evenodd"/><path fill="#000000" fill-opacity="0.0" d="m141.08661 156.06036l55.968506 0l0 65.41733l-55.968506 0z" fill-rule="evenodd"/><path fill="#000000" d="m150.02411 203.46036l11.0 -28.640625l4.078125 0l11.71875 28.640625l-4.3125 0l-3.34375 -8.671875l-11.96875 0l-3.140625 8.671875l-4.03125 0zm8.265625 -11.765625l9.703125 0l-2.984375 -7.921875q-1.359375 -3.609375 -2.03125 -5.9375q-0.546875 2.75 -1.546875 5.46875l-3.140625 8.390625z" fill-rule="nonzero"/><path fill="#000000" fill-opacity="0.0" d="m160.1181 306.5359l0 0c0 -12.8927 10.451599 -23.3443 23.3443 -23.3443l162.72873 0c6.191284 0 12.128998 2.4595032 16.506927 6.8374023c4.377899 4.377899 6.837372 10.315613 6.837372 16.506897l0 93.37442c0 12.8927 -10.451599 23.3443 -23.3443 23.3443l-162.72873 0c-12.8927 0 -23.3443 -10.451599 -23.3443 -23.3443z" fill-rule="evenodd"/><path stroke="#595959" stroke-width="1.0" stroke-linejoin="round" stroke-linecap="butt" d="m160.1181 306.5359l0 0c0 -12.8927 10.451599 -23.3443 23.3443 -23.3443l162.72873 0c6.191284 0 12.128998 2.4595032 16.506927 6.8374023c4.377899 4.377899 6.837372 10.315613 6.837372 16.506897l0 93.37442c0 12.8927 -10.451599 23.3443 -23.3443 23.3443l-162.72873 0c-12.8927 0 -23.3443 -10.451599 -23.3443 -23.3443z" fill-rule="evenodd"/><path fill="#000000" fill-opacity="0.0" d="m386.67978 208.25244l0 0c0 -12.8927 10.451599 -23.3443 23.3443 -23.3443l162.72873 0c6.191284 0 12.129028 2.4594727 16.506897 6.837387c4.3779297 4.377899 6.8374023 10.315613 6.8374023 16.506912l0 93.37439c0 12.8927 -10.451599 23.3443 -23.3443 23.3443l-162.72873 0c-12.8927 0 -23.3443 -10.451599 -23.3443 -23.3443z" fill-rule="evenodd"/><path stroke="#595959" stroke-width="1.0" stroke-linejoin="round" stroke-linecap="butt" d="m386.67978 208.25244l0 0c0 -12.8927 10.451599 -23.3443 23.3443 -23.3443l162.72873 0c6.191284 0 12.129028 2.4594727 16.506897 6.837387c4.3779297 4.377899 6.8374023 10.315613 6.8374023 16.506912l0 93.37439c0 12.8927 -10.451599 23.3443 -23.3443 23.3443l-162.72873 0c-12.8927 0 -23.3443 -10.451599 -23.3443 -23.3443z" fill-rule="evenodd"/><path fill="#000000" fill-opacity="0.0" d="m160.1181 283.1916l55.968506 0l0 65.41733l-55.968506 0z" fill-rule="evenodd"/><path fill="#000000" d="m171.46185 322.9116l0 -22.90625l8.59375 0q2.625 0 4.203125 0.703125q1.59375 0.6875 2.484375 2.140625q0.90625 1.4375 0.90625 3.015625q0 1.46875 -0.796875 2.765625q-0.796875 1.296875 -2.40625 2.09375q2.078125 0.609375 3.1875 2.078125q1.125 1.46875 1.125 3.46875q0 1.609375 -0.6875 3.0q-0.671875 1.375 -1.671875 2.125q-1.0 0.75 -2.515625 1.140625q-1.5 0.375 -3.6875 0.375l-8.734375 0zm3.03125 -13.28125l4.953125 0q2.015625 0 2.890625 -0.265625q1.15625 -0.34375 1.734375 -1.140625q0.59375 -0.796875 0.59375 -2.0q0 -1.140625 -0.546875 -2.0q-0.546875 -0.875 -1.5625 -1.1875q-1.015625 -0.328125 -3.484375 -0.328125l-4.578125 0l0 6.921875zm0 10.578125l5.703125 0q1.46875 0 2.0625 -0.109375q1.046875 -0.1875 1.75 -0.625q0.703125 -0.4375 1.15625 -1.265625q0.453125 -0.84375 0.453125 -1.9375q0 -1.28125 -0.65625 -2.21875q-0.65625 -0.953125 -1.828125 -1.328125q-1.15625 -0.390625 -3.34375 -0.390625l-5.296875 0l0 7.875z" fill-rule="nonzero"/><path fill="#000000" fill-opacity="0.0" d="m390.61942 184.90814l55.968506 0l0 65.41731l-55.968506 0z" fill-rule="evenodd"/><path fill="#000000" d="m401.96317 224.62814l0 -22.90625l8.59375 0q2.625 0 4.203125 0.703125q1.59375 0.6875 2.484375 2.140625q0.90625 1.4375 0.90625 3.015625q0 1.46875 -0.796875 2.765625q-0.796875 1.296875 -2.40625 2.09375q2.078125 0.609375 3.1875 2.078125q1.125 1.46875 1.125 3.46875q0 1.609375 -0.6875 3.0q-0.671875 1.375 -1.671875 2.125q-1.0 0.75 -2.515625 1.140625q-1.5 0.375 -3.6875 0.375l-8.734375 0zm3.03125 -13.28125l4.953125 0q2.015625 0 2.890625 -0.265625q1.15625 -0.34375 1.734375 -1.140625q0.59375 -0.796875 0.59375 -2.0q0 -1.140625 -0.546875 -2.0q-0.546875 -0.875 -1.5625 -1.1875q-1.015625 -0.328125 -3.484375 -0.328125l-4.578125 0l0 6.921875zm0 10.578125l5.703125 0q1.46875 0 2.0625 -0.109375q1.046875 -0.1875 1.75 -0.625q0.703125 -0.4375 1.15625 -1.265625q0.453125 -0.84375 0.453125 -1.9375q0 -1.28125 -0.65625 -2.21875q-0.65625 -0.953125 -1.828125 -1.328125q-1.15625 -0.390625 -3.34375 -0.390625l-5.296875 0l0 7.875z" fill-rule="nonzero"/><path fill="#000000" fill-opacity="0.0" d="m243.23097 337.22858l0 0c0 -6.7695923 5.487854 -12.257446 12.257462 -12.257446l71.95752 0c3.250885 0 6.368622 1.2914124 8.667328 3.5901184c2.2987366 2.2987366 3.5901184 5.4164734 3.5901184 8.667328l0 49.02838c0 6.769623 -5.487854 12.257477 -12.257446 12.257477l-71.95752 0l0 0c-6.7696075 0 -12.257462 -5.487854 -12.257462 -12.257477z" fill-rule="evenodd"/><path stroke="#595959" stroke-width="1.0" stroke-linejoin="round" stroke-linecap="butt" d="m243.23097 337.22858l0 0c0 -6.7695923 5.487854 -12.257446 12.257462 -12.257446l71.95752 0c3.250885 0 6.368622 1.2914124 8.667328 3.5901184c2.2987366 2.2987366 3.5901184 5.4164734 3.5901184 8.667328l0 49.02838c0 6.769623 -5.487854 12.257477 -12.257446 12.257477l-71.95752 0l0 0c-6.7696075 0 -12.257462 -5.487854 -12.257462 -12.257477z" fill-rule="evenodd"/><path fill="#000000" fill-opacity="0.0" d="m473.61417 241.30733l0 0c0 -6.7696075 5.487854 -12.257462 12.257477 -12.257462l71.95752 0c3.2508545 0 6.3685913 1.2914124 8.667297 3.5901337c2.298767 2.2987213 3.590149 5.416458 3.590149 8.667328l0 49.028397c0 6.7695923 -5.487854 12.257446 -12.257446 12.257446l-71.95752 0l0 0c-6.769623 0 -12.257477 -5.487854 -12.257477 -12.257446z" fill-rule="evenodd"/><path stroke="#595959" stroke-width="1.0" stroke-linejoin="round" stroke-linecap="butt" d="m473.61417 241.30733l0 0c0 -6.7696075 5.487854 -12.257462 12.257477 -12.257462l71.95752 0c3.2508545 0 6.3685913 1.2914124 8.667297 3.5901337c2.298767 2.2987213 3.590149 5.416458 3.590149 8.667328l0 49.028397c0 6.7695923 -5.487854 12.257446 -12.257446 12.257446l-71.95752 0l0 0c-6.769623 0 -12.257477 -5.487854 -12.257477 -12.257446z" fill-rule="evenodd"/><path fill="#000000" fill-opacity="0.0" d="m480.0 229.04987l55.968506 0l0 65.41733l-55.968506 0z" fill-rule="evenodd"/><path fill="#000000" d="m503.10938 255.05862l2.28125 0.578125q-0.71875 2.796875 -2.578125 4.28125q-1.859375 1.46875 -4.546875 1.46875q-2.765625 0 -4.515625 -1.125q-1.734375 -1.140625 -2.640625 -3.28125q-0.90625 -2.15625 -0.90625 -4.609375q0 -2.6875 1.015625 -4.6875q1.03125 -2.0 2.921875 -3.03125q1.890625 -1.03125 4.171875 -1.03125q2.578125 0 4.328125 1.3125q1.765625 1.3125 2.453125 3.6875l-2.234375 0.53125q-0.609375 -1.875 -1.75 -2.734375q-1.125 -0.859375 -2.84375 -0.859375q-1.984375 0 -3.3125 0.953125q-1.328125 0.953125 -1.875 2.546875q-0.53125 1.59375 -0.53125 3.296875q0 2.1875 0.625 3.828125q0.640625 1.640625 1.984375 2.453125q1.359375 0.796875 2.921875 0.796875q1.921875 0 3.234375 -1.09375q1.328125 -1.109375 1.796875 -3.28125z" fill-rule="nonzero"/><path fill="#000000" fill-opacity="0.0" d="m243.23097 324.97113l55.96849 0l0 65.41733l-55.96849 0z" fill-rule="evenodd"/><path fill="#000000" d="m266.34033 350.9799l2.28125 0.578125q-0.71875 2.796875 -2.578125 4.28125q-1.859375 1.46875 -4.546875 1.46875q-2.765625 0 -4.515625 -1.125q-1.7343597 -1.140625 -2.6406097 -3.28125q-0.90625 -2.15625 -0.90625 -4.609375q0 -2.6875 1.015625 -4.6875q1.03125 -2.0 2.9218597 -3.03125q1.890625 -1.03125 4.171875 -1.03125q2.578125 0 4.328125 1.3125q1.765625 1.3125 2.453125 3.6875l-2.234375 0.53125q-0.609375 -1.875 -1.75 -2.734375q-1.125 -0.859375 -2.84375 -0.859375q-1.984375 0 -3.3125 0.953125q-1.328125 0.953125 -1.875 2.546875q-0.53123474 1.59375 -0.53123474 3.296875q0 2.1875 0.62498474 3.828125q0.640625 1.640625 1.984375 2.453125q1.359375 0.796875 2.921875 0.796875q1.921875 0 3.234375 -1.09375q1.328125 -1.109375 1.796875 -3.28125z" fill-rule="nonzero"/><path fill="#000000" fill-opacity="0.0" d="m443.15222 360.8664l0 0c0 -6.769623 5.487854 -12.257477 12.257477 -12.257477l71.95749 0c3.2509155 0 6.3686523 1.2914124 8.667358 3.590149c2.298706 2.298706 3.590149 5.416443 3.590149 8.667328l0 49.02838c0 6.7695923 -5.487854 12.257446 -12.257507 12.257446l-71.95749 0l0 0c-6.769623 0 -12.257477 -5.487854 -12.257477 -12.257446z" fill-rule="evenodd"/><path stroke="#595959" stroke-width="1.0" stroke-linejoin="round" stroke-linecap="butt" d="m443.15222 360.8664l0 0c0 -6.769623 5.487854 -12.257477 12.257477 -12.257477l71.95749 0c3.2509155 0 6.3686523 1.2914124 8.667358 3.590149c2.298706 2.298706 3.590149 5.416443 3.590149 8.667328l0 49.02838c0 6.7695923 -5.487854 12.257446 -12.257507 12.257446l-71.95749 0l0 0c-6.769623 0 -12.257477 -5.487854 -12.257477 -12.257446z" fill-rule="evenodd"/><path fill="#000000" fill-opacity="0.0" d="m443.15222 348.60892l55.968506 0l0 65.41733l-55.968506 0z" fill-rule="evenodd"/><path fill="#000000" d="m454.0116 380.64893l0 -17.1875l5.90625 0q2.015625 0 3.0625 0.25q1.484375 0.34375 2.515625 1.234375q1.359375 1.140625 2.03125 2.9375q0.6875 1.78125 0.6875 4.078125q0 1.953125 -0.46875 3.46875q-0.453125 1.515625 -1.171875 2.515625q-0.703125 0.984375 -1.5625 1.546875q-0.84375 0.5625 -2.046875 0.859375q-1.203125 0.296875 -2.765625 0.296875l-6.1875 0zm2.265625 -2.03125l3.671875 0q1.703125 0 2.65625 -0.3125q0.96875 -0.3125 1.546875 -0.890625q0.8125 -0.8125 1.265625 -2.171875q0.453125 -1.375 0.453125 -3.3125q0 -2.703125 -0.890625 -4.140625q-0.890625 -1.453125 -2.15625 -1.9375q-0.90625 -0.359375 -2.9375 -0.359375l-3.609375 0l0 13.125z" fill-rule="nonzero"/></g></svg>
                    <p>
                        In this model there are 21 different locations:
                        the four spaces <code>around</code>, <code>contained</code>, <code>on</code>, and <code>under</code> each of the six membranes,
                        except the outermost membrane does not have the <code>around</code>, <code>on</code>, or <code>under</code> locations.
                    </p>
                    <p>Line breaks can be used when defining the initial tree, to increase readability, so this tree could be written as:</p>
                    <pre><code>
                        initial tree { A
                                       { 2 B
                                         { C }
                                       }
                                       { D }
                                     }
                    </code></pre>

                </div>

                <h4>Species</h4><hr>
                <div>

                    <p>
                        Species are the parts of the model that change over time.
                        Species exist within locations relative to membranes.
                        Reactions modify the number of species in each location.
                    </p>
                    <p>
                        Species names are never used on their own.
                        They are always accompanied by a location relative to a membrane, in the following pattern:
                    </p>
                    <pre><code>species_name location membrane</code></pre>
                    <p>For example:</p>
                    <pre><code>receptor on cell</code></pre>
                    <p>where <code>receptor</code> is the name of a species, and <code>cell</code> is the name of a membrane.</p>



                    <p>The state of the simulation at each time point is the number of each species present in each location in the model.</p>

                    <p>Species can appear in three different contexts in MDSL files:</p>
                    <ol>
                        <li>species definitions,</li>
                        <li>reactants and products of reactions,</li>
                        <li>reaction modifiers.</li>
                    </ol>


                    <h5>Species definitions</h5><hr>
                    <div>

                        <pre><code>
                            species r on cell = 10 receptors.cell^-1
                        </code></pre>
                        <p>Species definitions set the initial number of each species present at the start of the simulation.</p>

                        <p>
                            The units must be specified in each species definition, but these units are not used or checked during the simulation.
                        </p>

                        <p>
                            If a species definition references a membrane that there are multiple copies of in the <code>initial tree</code>,
                            then that number of the species is added to each membrane.
                            For example, the following code creates three copies of membrane <code>A</code>, each with five copies of
                            species <code>x</code> inside.
                            Thus there will be 15 species <code>x</code> in the whole simulation.
                        </p>
                        <pre><code>
                            initial tree {simulation {3 A}}
                            species x contained A = 5 units  # 15 copies of species x created
                        </code></pre>
                        <p>
                            NB: for species definitions that are specified with an <code>around</code> location,
                            the <code>around</code> will resolve to the parent membrane before the decision of how many species to add.
                            So the following code will create only three of species <code>x</code>.
                        </p>
                        <pre><code>
                            initial tree {simulation {3 A}}
                            species x around A = 5 units  # 3 copies of species x created
                        </code></pre>

                    </div>

                    <h5>Reactants and products of reactions</h5><hr>
                    <div>

                        <pre><code>
                            a_r_complex on cell modifier k_signal => a_r_complex on cell and 2 b contained cell
                        </code></pre>
                        <p>The left hand side (reactants) and right hand side (products) of reactions are species in locations.</p>

                    </div>

                    <h5>Reaction modifiers</h5><hr>
                    <div>

                        <pre><code>
                            a contained A modifier 3 * (x contained A + y contained A) => b contained A
                        </code></pre>
                        <p>Reaction modifiers are equations, which can contain located species as terms in the equation.</p>
                        <p>
                            When used as terms in a modifier equation, the species numbers will not be modified when the reaction fires,
                            but they will influence the rate of the reaction.
                            This can be used to create rate equations that would not be possible by just including these species in the stoichiometry of the reaction,
                            for example the reaction above, with modifier <code>3 * (x contained A + y contained A)</code>.
                        </p>

                    </div>

                    <h5>Location context blocks</h5><hr>
                    <div>
                        <p>It can be cumbersome to write the locations for each species all the time, particularly when species are used in reaction modifiers.</p>
                        <p>If multiple species are referenced within the same location, then a location context block can be used to simplify the MDSL.</p>
                        <p>For example, the following two snippets of code define the same model:</p>
                        <pre><code>
                            species a contained M = 1 units
                            species b contained M = 2 units
                            species c on M = 3 units

                            parameter k = 4 units

                            a contained M binds b contained M modifier k => b contained M
                            c on M modifier (a contained M + b contained M) / b contained M => d under M
                        </code></pre>
                        <pre><code>
                            contained M {
                              species a = 1 units
                              species b = 2 units
                              species c on M = 3 units

                              parameter k = 4 units

                              a binds b modifier k => b
                              c on M modifier (a + b) / b => d under M
                            }
                        </code></pre>
                        <p>
                            Location context blocks automatically insert a given location into any species names that are used without a location inside the block.
                            Other locations can be used inside the block (for example <code>on M</code> and <code>under M</code> above), as long as they are specified explicitly.
                        </p>
                    </div>

                </div>

                <h4>Parameters</h4><hr>
                <div>

                    <p>
                        Parameters are numbers used to define the rates of reactions.
                        They are evaluated before the simulation runs, and their value does not change during the simulation.
                    </p>
                    <p>Some examples of parameter definitions are:</p>
                    <pre><code>
                        parameter k_on = 0.2 ml.ng^-1.cell.receptors^-1.hour^-1
                        parameter k_d = 0.005 ng.ml^-1
                        parameter k_off = k_on / k_d cell.receptors^-1.hour^-1
                    </code></pre>
                    <p>
                        Parameters can be simple numbers, or equations referencing other parameters.
                        Because parameters do not change as the simulation runs, they cannot reference species numbers (in contrast to modifier equations in reactions).
                    </p>
                    <p>The full list of what can be specified in parameter equations is:</p>
                    <ul>
                        <li>Numbers
                            <ul>
                                <li><code>52</code>, <code>3</code>, <code>42.6</code></li>
                                <li>Scientific notation: <code>1.2e+6</code>, <code>5E-2</code></li>
                            </ul>
                        </li>
                        <li>Arithmetic operations
                            <ul>
                                <li><code>+</code>, <code>-</code>, <code>*</code>, <code>/</code></li>
                                <li>Also unary minus: <code>-k2</code>, <code>-(k1 + k2)</code></li>
                            </ul>
                        </li>
                        <li>Other parameters
                            <ul>
                                <li><code>k_on / k_d</code></li>
                                <li>As long as they are defined earlier in the file than when they are used</li>
                            </ul>
                        </li>
                        <li>Brackets
                            <ul>
                                <li><code>(a + b) / b</code></li>
                            </ul>
                        </li>
                        <li>Ln function
                            <ul>
                                <li><code>ln(2)</code>, <code>ln(k + 7)</code></li>
                                <li>The natural logarithm function</li>
                            </ul>
                        </li>
                        <li>Round function
                            <ul>
                                <li><code>round(k / 3)</code></li>
                                <li>Rounds its input to the nearest whole number</li>
                            </ul>
                        </li>
                    </ul>

                    <h5>Parameters output file</h5><hr>
                    <div>
                        <p>
                            To aid in checking that parameter equations have been written correctly,
                            the simulator outputs a file named <code>output_Parameters.txt</code>,
                            containing all the parameter definitions, along with the numbers that they evaluate to.
                            An example of this file is shown below:
                        </p>
                        <pre><code>
                            Parameters equations defined in the model file:
                            parameter k_on = (0.2) ml.ng^-1.cell.receptors^-1.hour^-1
                            parameter k_d = (0.005) ng.ml^-1
                            parameter k_off = ((k_on) / (k_d)) cell.receptors^-1.hour^-1

                            Parameter values computed:
                            parameter k_on = 0.2 ml.ng^-1.cell.receptors^-1.hour^-1
                            parameter k_d = 0.005 ng.ml^-1
                            parameter k_off = 40.0 cell.receptors^-1.hour^-1
                        </code></pre>
                        <p>
                            The first part of this file shows the parameter equations with all their implicit brackets added.
                            This makes clear the order of precedence of the operators in the equations.
                        </p>
                        <p>
                            The second part of this file shows the actual numbers that the equations evaluate to.
                        </p>
                    </div>

                </div>

                <h4>Reactions</h4><hr>
                <div>

                    <p>
                        Reactions are what make the simulation run.
                        When a reaction fires, the reactant species are removed and the product species are added.
                        This causes the propensities of other reactions to change.
                    </p>
                    <pre><code>
                        a contained M binds 2 b contained M modifier k => c contained M
                    </code></pre>

                    <h5>Modifiers and propensities</h5><hr>
                    <div>
                        <p>The reaction modifier is the equation that comes immediately after the <code>modifier</code> keyword.</p>
                        <p>
                            This can be a simple rate constant: a number or a parameter (in the above example, it is the parameter <code>k</code>).
                            Or it can be a complex equation, potentially involving multiple parameters and species concentrations.
                        </p>
                        <p>The propensity of each reaction is calculated as follows:</p>
                        <ul>
                            <li>propensity = <code>k</code>
                                               * <sup><code>[r(1)]</code></sup>C<sub><code>s(1)</code></sub>
                                               * <sup><code>[r(2)]</code></sup>C<sub><code>s(2)</code></sub>
                                               * ...
                                               * <sup><code>[r(n)]</code></sup>C<sub><code>s(n)</code></sub>
                            </li>
                        </ul>
                        <p>where:</p>
                        <ul>
                            <li>the modifier is <code>k</code></li>
                            <li>the reactant species are named <code>r(1)</code>, <code>r(2)</code>, ..., <code>r(n)</code></li>
                            <li>the stoichiometries of each reactant are <code>s(1)</code>, <code>s(2)</code>, ..., <code>s(n)</code></li>
                            <li>the concentrations of each species in the relevant space are <code>[r(1)]</code>, <code>[r(2)]</code>, ..., <code>[r(n)]</code></li>
                            <li><sup>n</sup>C<sub>r</sub> is the combinatoric function <code>n! / r!(n - r)!</code>,
                                the number of ways of choosing <code>r</code> objects from a collection of <code>n</code> identical objects without replacement</li>
                        </ul>
                        <p>This models the likelihood that all the reactants of the reaction will come close enough to react.</p>
                    </div>

                    <h5>Reversible reactions</h5><hr>
                    <div>
                        <p>TODO: Two-way reactions</p>
                    </div>

                    <h5>Combiners</h5><hr>
                    <div>
                        <p>TODO: Two combiners: <code>binds</code>, <code>and</code></p>
                    </div>

                    <h5>Genes and catalysts</h5><hr>
                    <div>
                        <p>TODO: Gene/catalyst reactants not removed, but are checked for stoichiometry 1 when calculating rate. Same as including on both sides.</p>
                    </div>

                    <h5>Delays</h5><hr>
                    <div>
                        <p>TODO: Delays</p>
                    </div>

                </div>

                <h4>Gillespie simulation algorithm</h4><hr>
                <div>

                    <p>
                        The MDSL simulator implements a modified version of Gillespie's algorithm for simulating networks of chemical reactions.
                        <br>
                        Reference:
                        <cite>
                            Exact stochastic simulation of coupled chemical reactions,
                            Daniel T. Gillespie,
                            J. Phys. Chem., 1977, 81 (25), pp 2340–2361,
                            DOI: <a href="https://doi.org/10.1021%2Fj100540a008" target="_blank">10.1021/j100540a008</a>
                        </cite>
                    </p>

                    <h5>Algorithm</h5><hr>
                    <div>
                        <p>The basic premise of the algorithm is as follows:</p>
                        <ul>
                            <li>while simulation time has not elapsed
                                <ol>
                                    <li>Calculate the propensities of each reaction in each membrane</li>
                                    <li>Randomly choose the time at which the next reaction fires, using the reaction propensities
                                        <ul>
                                            <li>Using Equation 21a in Gillespie's paper</li>
                                            <li>time to next reaction = (1.0 / (sum of propensities)) * log(1.0 / (random number between 0 and 1))</li>
                                        </ul>
                                    </li>
                                    <li>Choose a reaction randomly, weighted by propensity</li>
                                    <li>Fire this reaction
                                        <ul>
                                            <li>Increase the simulation time by the time chosen in step 2 above</li>
                                            <li>Remove the reaction's reactants from the simulation</li>
                                            <li>Add the reaction's products to the simulation</li>
                                        </ul>
                                    </li>
                                </ol>
                            </li>
                        </ul>
                        <p>
                            Reactions are randomly chosen and fired, with faster reactions more likely to be chosen over slower ones,
                            with time advancing using a non-uniform timestep.
                        </p>
                    </div>

                    <h5>Optimisations</h5><hr>
                    <div>
                        <p>Our implementation of Gillespie's algorithm is an optimised version of the above algorithm.</p>
                        <p>
                            For example, we do not recalculate the propensities of every reaction in every membrane at each step.
                            We only recalculate the propensities of reactions that depend on species that were changed by the previous reaction,
                            and we only recalculate propensities in membranes that could have had their species changed by the previous reaction.
                        </p>
                    </div>

                    <h5>Additional features</h5><hr>
                    <div>
                        <p>The MDSL simulator has two features that are not present in the original Gillespie algorithm: membranes and delays.</p>
                        <p>
                            Membranes allow different species to exist in different concentration in different spaces in the same simulation.
                            And they allow reactions to happen differently in different spaces.
                            The original Gillespie algorithm simulates a single space.
                            MDSL allows you to define as many spaces as required for your simulation, and have reactions move species between these spaces.
                        </p>
                        <p>
                            Delays allow a reaction to fire at a certain time, removing its reactants from the simulation,
                            but waiting for a fixed time to elapse before adding its products to the simulation.
                            The original Gillespie algorithm has reaction products added to the simulation instantaneously (delay 0 on every reaction).
                            This is the default in MDSL, but in MDSL delays can be specified if desired.
                        </p>
                    </div>

                </div>

            </div>
            </div>

            <h3>Full MDSL grammar</h3><hr>
            <div>
                <p>
                    The full grammar for MDSL is available as
                    <a href="MembraneModel.g4">an antlr g4 file</a> and as
                    <a href="mdsl_grammar_diagrams.html">railroad diagrams</a>.
                </p>
            </div>

        </div>

    </div>
</div>

</body>
</html>
